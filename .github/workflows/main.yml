name: MC-Server-Runner

on:
  workflow_dispatch:
    inputs:
      mc_version:
        description: 'Minecraft Version'
        type: string
        default: '1.20.1'
      mod_loader:
        description: 'Loader (vanilla, paper, fabric, forge)'
        type: string
        default: 'paper'
      java_type:
        description: 'Java (graalvm or temurin)'
        type: string
        default: 'graalvm'
      java_version:
        description: 'Java Version'
        type: string
        default: '21'
      online_mode:
        description: 'Online Mode'
        type: string
        default: 'false'
      server_port:
        description: 'Port'
        type: string
        default: '25565'
      motd:
        description: 'MOTD'
        type: string
        default: 'GitHub Hosted Server'
      difficulty:
        description: 'Difficulty'
        type: string
        default: 'easy'
      seed:
        description: 'Seed'
        type: string
        default: ''

jobs:
  run-server:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Java
        if: github.event.inputs.java_type != 'graalvm'
        uses: actions/setup-java@v4
        with:
          java-version: ${{ github.event.inputs.java_version }}
          distribution: 'temurin'

      - name: Install GraalVM
        if: github.event.inputs.java_type == 'graalvm'
        run: |
          curl -s "https://get.sdkman.io" | bash
          source "$HOME/.sdkman/bin/sdkman-init.sh"
          sdk install java ${{ github.event.inputs.java_version }}-graalce
          sdk use java ${{ github.event.inputs.java_version }}-graalce
          echo "JAVA_HOME=$HOME/.sdkman/candidates/java/current" >> $GITHUB_ENV
          echo "$HOME/.sdkman/candidates/java/current/bin" >> $GITHUB_PATH

      - name: Data Setup
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p data
          cd data
          if gh release view backup &>/dev/null; then
            gh release download backup -p "world.zip" --clobber || echo "No world backup found."
            if [ -f "world.zip" ]; then
              unzip -o world.zip
              rm -f world.zip
            fi
          fi

      - name: Download Server
        working-directory: ./data
        run: |
          MC="${{ github.event.inputs.mc_version }}"
          case "${{ github.event.inputs.mod_loader }}" in
            paper)
              BUILD=$(curl -s "https://api.papermc.io/v2/projects/paper/versions/$MC/builds" | jq -r '.builds[-1].build')
              curl -L -o server.jar "https://api.papermc.io/v2/projects/paper/versions/$MC/builds/$BUILD/downloads/paper-$MC-$BUILD.jar"
              ;;
            fabric)
              LOADER=$(curl -s https://meta.fabricmc.net/v2/versions/loader | jq -r '.[0].version')
              INSTALLER=$(curl -s https://meta.fabricmc.net/v2/versions/installer | jq -r '.[0].version')
              curl -L -o server.jar "https://meta.fabricmc.net/v2/versions/loader/$MC/$LOADER/$INSTALLER/server/jar"
              ;;
            forge)
              FORGE_VERSION=$(curl -s "https://files.minecraftforge.net/net/minecraftforge/forge/promotions_slim.json" | jq -r ".promos[\"$MC-latest\"]")
              curl -L -o installer.jar "https://maven.minecraftforge.net/net/minecraftforge/forge/$MC-$FORGE_VERSION/forge-$MC-$FORGE_VERSION-installer.jar"
              java -jar installer.jar --installServer
              rm -f installer.jar
              ;;
            *)
              VERSION_URL=$(curl -s "https://launchermeta.mojang.com/mc/game/version_manifest.json" | jq -r --arg V "$MC" '.versions[] | select(.id == $V) | .url')
              DOWNLOAD_URL=$(curl -s "$VERSION_URL" | jq -r '.downloads.server.url')
              curl -L -o server.jar "$DOWNLOAD_URL"
              ;;
          esac

      - name: Configure Server
        working-directory: ./data
        run: |
          echo "eula=true" > eula.txt
          cat > server.properties << 'EOF'
online-mode=${{ github.event.inputs.online_mode }}
motd=${{ github.event.inputs.motd }}
difficulty=${{ github.event.inputs.difficulty }}
level-seed=${{ github.event.inputs.seed }}
server-port=${{ github.event.inputs.server_port }}
enable-rcon=false
enable-command-block=true
max-players=20
view-distance=10
allow-flight=true
EOF

      - name: Setup Networking
        env:
          PLAYIT_SECRET: ${{ secrets.PLAYIT_SECRET }}
        run: |
          if [ -z "$PLAYIT_SECRET" ]; then
            echo "Error: PLAYIT_SECRET is not set in Secrets."
          else
            curl -SsL https://playit-cloud.github.io/ppa/key.gpg | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/playit.gpg
            echo "deb [signed-by=/etc/apt/trusted.gpg.d/playit.gpg] https://playit-cloud.github.io/ppa/ubuntu ./" | sudo tee /etc/apt/sources.list.d/playit-cloud.list
            sudo apt update && sudo apt install -y playit
            nohup playit --secret "$PLAYIT_SECRET" > playit.log 2>&1 &
            echo $! > /tmp/playit.pid
            sleep 10
            grep -oE "[a-z0-9]+\.[a-z]+\.(playit\.gg|joinmc\.link)" playit.log | head -1 || echo "Check playit.gg dashboard"
          fi

      - name: Run Server
        working-directory: ./data
        timeout-minutes: 360
        run: |
          if [ -f "run.sh" ]; then
            chmod +x run.sh
            ./run.sh nogui
          else
            java -Xmx6G -Xms6G -jar server.jar nogui
          fi

      - name: Backup and Cleanup
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f "/tmp/playit.pid" ]; then
            kill $(cat /tmp/playit.pid) 2>/dev/null || true
          fi

          if [ -d "data/world" ]; then
            cd data
            zip -r ../world-backup.zip world world_nether world_the_end 2>/dev/null || zip -r ../world-backup.zip world
            cd ..
          fi

          if [ -f "world-backup.zip" ]; then
            if gh release view backup &>/dev/null; then
              gh release upload backup world-backup.zip --clobber
            else
              gh release create backup world-backup.zip --title "World Backup" --notes "Automated backup"
            fi
          fi

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add data/*.properties 2>/dev/null || true
          git commit -m "Update server configuration" && git push || echo "No changes to commit"
