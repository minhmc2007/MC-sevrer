name: Minecraft Server (Aternos Alternative)

on:
  workflow_dispatch:
    inputs:
      mc_version:
        description: 'Minecraft Version'
        default: '1.20.1'
        required: true
      mod_loader:
        description: 'Mod Loader'
        type: choice
        options:
        - vanilla
        - paper
        - fabric
        - forge
        default: forge
      java_distro:
        description: 'Java Distribution'
        type: choice
        options:
        - stock
        - graalvm
        default: stock
      java_version:
        description: 'Java Version (17 for 1.20.1, 21 for 1.20.5+)'
        default: '17'
        required: true
      # Server Properties
      motd:
        description: 'Server MOTD'
        default: 'A GitHub Actions Server'
      difficulty:
        description: 'Difficulty'
        type: choice
        options: [peaceful, easy, normal, hard]
        default: normal
      hardcore:
        description: 'Hardcore Mode'
        type: boolean
        default: false
      online_mode:
        description: 'Online Mode (False = Cracked/Offline)'
        type: boolean
        default: true
      seed:
        description: 'Level Seed (Leave empty for random)'
        default: ''
      max_players:
        description: 'Max Players'
        default: '20'

jobs:
  play-minecraft:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --- Java Setup ---
      - name: Setup Stock Java
        if: ${{ inputs.java_distro == 'stock' }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ inputs.java_version }}

      - name: Setup GraalVM (SDKMAN)
        if: ${{ inputs.java_distro == 'graalvm' }}
        run: |
          curl -s "https://get.sdkman.io" | bash
          source "$HOME/.sdkman/bin/sdkman-init.sh"
          sdk install java ${{ inputs.java_version }}-graalce || sdk install java 17-graalce
          echo "JAVA_HOME=$JAVA_HOME" >> $GITHUB_ENV
          echo "$HOME/.sdkman/candidates/java/current/bin" >> $GITHUB_PATH

      # --- Preparation ---
      - name: Create Data Directory
        run: mkdir -p data

      - name: Restore World from Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download backup -p "world.zip" -D data || echo "No backup found."
          cd data && [ -f world.zip ] && unzip -o world.zip && rm world.zip || echo "Fresh start."

      # --- Download Server Jar ---
      - name: Download Server Software
        working-directory: ./data
        run: |
          MC_VERSION="${{ inputs.mc_version }}"
          LOADER="${{ inputs.mod_loader }}"
          if [ "$LOADER" = "paper" ]; then
            BUILD=$(curl -s https://api.papermc.io/v2/projects/paper/versions/$MC_VERSION/builds | jq -r '.builds[-1].build')
            curl -o server.jar "https://api.papermc.io/v2/projects/paper/versions/$MC_VERSION/builds/$BUILD/downloads/paper-$MC_VERSION-$BUILD.jar"
          elif [ "$LOADER" = "fabric" ]; then
            curl -OJ "https://meta.fabricmc.net/v2/versions/loader/$MC_VERSION/stable/1.0.0/server/jar"
            mv fabric-server-mc*.jar server.jar
          elif [ "$LOADER" = "vanilla" ]; then
            URL=$(curl -s https://launchermeta.mojang.com/mc/game/version_manifest.json | jq -r --arg V "$MC_VERSION" '.versions[] | select(.id == $V) | .url' | xargs curl -s | jq -r '.downloads.server.url')
            curl -o server.jar "$URL"
          elif [ "$LOADER" = "forge" ]; then
            FORGE_V=$(curl -s "https://files.minecraftforge.net/net/minecraftforge/forge/promotions_slim.json" | jq -r ".promos[\"$MC_VERSION-latest\"] // .promos[\"$MC_VERSION-recommended\"]")
            curl -o forge-installer.jar "https://maven.minecraftforge.net/net/minecraftforge/forge/$MC_VERSION-$FORGE_V/forge-$MC_VERSION-$FORGE_V-installer.jar"
            java -jar forge-installer.jar --installServer
          fi

      # --- Configure Server ---
      - name: Configure Server
        working-directory: ./data
        run: |
          echo "eula=true" > eula.txt
          cat <<EOF > server.properties
          difficulty=${{ inputs.difficulty }}
          hardcore=${{ inputs.hardcore }}
          level-seed=${{ inputs.seed }}
          max-players=${{ inputs.max_players }}
          motd=${{ inputs.motd }}
          online-mode=${{ inputs.online_mode }}
          server-port=25565
          EOF

      - name: Setup Playit.gg Tunnel
        env:
          PLAYIT_SECRET: ${{ secrets.PLAYIT_SECRET }}
        run: |
          curl -SsL https://playit-cloud.github.io/ppa/key.gpg | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/playit.gpg >/dev/null
          echo "deb [signed-by=/etc/apt/trusted.gpg.d/playit.gpg] https://playit-cloud.github.io/ppa/data ./" | sudo tee /etc/apt/sources.list.d/playit-cloud.list
          sudo apt-get update && sudo apt-get install -y playit
          
          echo "Starting Playit..."
          if [ -z "$PLAYIT_SECRET" ]; then
            playit > playit.log 2>&1 &
            sleep 15
            echo "--- !!! ACTION REQUIRED: CLAIM YOUR IP !!! ---"
            grep -o "https://playit.gg/claim/[^ ]*" playit.log || cat playit.log
          else
            # Start with secret
            playit --secret "$PLAYIT_SECRET" > playit.log 2>&1 &
            sleep 15
            echo "--- YOUR SERVER IP ADDRESS ---"
            # This line finds the actual .playit.gg address in the logs
            grep -oE "[a-zA-Z0-9.-]+\.playit\.gg" playit.log | head -n 1 || echo "IP not found in logs yet, check Playit.gg Dashboard"
          fi
          echo "------------------------------------------"

      # --- Run Server ---
      - name: Start Minecraft Server
        working-directory: ./data
        run: |
          if [ "${{ inputs.mod_loader }}" = "forge" ]; then
            chmod +x run.sh && ./run.sh nogui
          else
            java -Xms4G -Xmx6G -jar server.jar nogui
          fi

      # --- Backup Logic ---
      - name: Backup World
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -d "data/world" ]; then
            zip -r data/world.zip data/world data/world_nether data/world_the_end
            gh release create backup --title "World Backup" data/world.zip --target $GITHUB_SHA || gh release upload backup data/world.zip --clobber
            rm -rf data/world.zip data/world data/world_nether data/world_the_end data/*.jar data/libraries data/logs
            git config --global user.name "Backup"
            git config --global user.email "actions@github.com"
            git add data/ && git commit -m "Save configs [skip ci]" && git push || echo "No changes."
          fi
