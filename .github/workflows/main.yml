name: Minecraft Server (Aternos Alternative)

on:
  workflow_dispatch:
    inputs:
      mc_version:
        description: 'Minecraft Version'
        default: '1.20.4'
        required: true
      mod_loader:
        description: 'Mod Loader'
        type: choice
        options:
        - vanilla
        - paper
        - fabric
        - forge
        default: paper
      java_distro:
        description: 'Java Distribution'
        type: choice
        options:
        - stock
        - graalvm
        default: stock
      java_version:
        description: 'Java Version (Recommended: 21 for modern)'
        default: '21'
        required: true
      # Server Properties
      motd:
        description: 'Server MOTD'
        default: 'A GitHub Actions Server'
      difficulty:
        description: 'Difficulty'
        type: choice
        options: [peaceful, easy, normal, hard]
        default: normal
      hardcore:
        description: 'Hardcore Mode'
        type: boolean
        default: false
      online_mode:
        description: 'Online Mode (False = Crack/Offline)'
        type: boolean
        default: true
      seed:
        description: 'Level Seed (Leave empty for random)'
        default: ''
      max_players:
        description: 'Max Players'
        default: '20'

jobs:
  play-minecraft:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed to push changes and upload releases

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --- Java Setup ---
      - name: Setup Stock Java
        if: ${{ inputs.java_distro == 'stock' }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ inputs.java_version }}

      - name: Setup GraalVM (SDKMAN)
        if: ${{ inputs.java_distro == 'graalvm' }}
        run: |
          curl -s "https://get.sdkman.io" | bash
          source "$HOME/.sdkman/bin/sdkman-init.sh"
          # Try to install the requested version, falling back to 21 if specific format fails
          sdk install java ${{ inputs.java_version }}-graalce || sdk install java 21-graalce
          echo "JAVA_HOME=$JAVA_HOME" >> $GITHUB_ENV
          echo "$HOME/.sdkman/candidates/java/current/bin" >> $GITHUB_PATH

      # --- Preparation ---
      - name: Create Data Directory
        run: mkdir -p data

      - name: Restore World from Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for previous backup..."
          gh release download backup -p "world.zip" -D data || echo "No backup found, starting fresh."
          cd data
          if [ -f world.zip ]; then
            unzip -o world.zip
            rm world.zip
            echo "World restored."
          fi

      # --- Download Server Jar ---
      - name: Download Server JAR
        working-directory: ./data
        run: |
          VERSION="${{ inputs.mc_version }}"
          LOADER="${{ inputs.mod_loader }}"
          
          echo "Downloading $LOADER for Minecraft $VERSION..."
          
          if [ "$LOADER" = "paper" ]; then
            BUILD=$(curl -s https://api.papermc.io/v2/projects/paper/versions/$VERSION/builds | jq -r '.builds[-1].build')
            curl -o server.jar "https://api.papermc.io/v2/projects/paper/versions/$VERSION/builds/$BUILD/downloads/paper-$VERSION-$BUILD.jar"
          
          elif [ "$LOADER" = "fabric" ]; then
            curl -OJ "https://meta.fabricmc.net/v2/versions/loader/$VERSION/stable/1.0.0/server/jar"
            mv fabric-server-mc*.jar server.jar
          
          elif [ "$LOADER" = "vanilla" ]; then
            # Complex logic to get Vanilla URL via Piston Meta
            MANIFEST_URL=$(curl -s https://launchermeta.mojang.com/mc/game/version_manifest.json | jq -r --arg V "$VERSION" '.versions[] | select(.id == $V) | .url')
            DOWNLOAD_URL=$(curl -s $MANIFEST_URL | jq -r '.downloads.server.url')
            curl -o server.jar $DOWNLOAD_URL
            
          elif [ "$LOADER" = "forge" ]; then
            echo "Forge auto-install is complex in Actions. Please switch to Fabric or Paper for best results."
            exit 1
          fi
          
          chmod +x server.jar

      # --- Configure Server ---
      - name: Generate server.properties
        working-directory: ./data
        run: |
          echo "eula=true" > eula.txt
          
          cat <<EOF > server.properties
          #Generated by GitHub Actions
          accepts-transfers=false
          allow-flight=true
          difficulty=${{ inputs.difficulty }}
          enable-rcon=false
          gamemode=survival
          hardcore=${{ inputs.hardcore }}
          level-seed=${{ inputs.seed }}
          max-players=${{ inputs.max_players }}
          motd=${{ inputs.motd }}
          online-mode=${{ inputs.online_mode }}
          server-port=25565
          server-ip=0.0.0.0
          spawn-protection=0
          view-distance=10
          EOF

      # --- Networking (REQUIRED to join) ---
      - name: Setup Playit.gg Tunnel
        run: |
          curl -SsL https://playit-cloud.github.io/ppa/key.gpg | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/playit.gpg >/dev/null
          echo "deb [signed-by=/etc/apt/trusted.gpg.d/playit.gpg] https://playit-cloud.github.io/ppa/data ./" | sudo tee /etc/apt/sources.list.d/playit-cloud.list
          sudo apt-get update
          sudo apt-get install playit
          
          # Start playit in background
          if [ "${{ secrets.PLAYIT_SECRET }}" != "" ]; then
             playit --secret ${{ secrets.PLAYIT_SECRET }} &
             echo "Playit started with your secret key."
          else
             playit &
             echo "Playit started. CHECK THE LOGS BELOW for the claim URL to get your IP!"
          fi

      # --- Run Server ---
      - name: Start Minecraft Server
        working-directory: ./data
        run: |
          # Give Playit a moment to start
          sleep 10
          
          echo "-----------------------------------------------------"
          echo " STARTING SERVER - IT WILL RUN FOR MAX 6 HOURS "
          echo "-----------------------------------------------------"
          
          java -Xms4G -Xmx6G -jar server.jar nogui

      # --- Backup Logic (Runs even if cancelled/stopped) ---
      - name: Backup World to Release
        if: always() # Runs even if you cancel the workflow
        working-directory: ./data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Server stopped. Starting backup..."
          
          # 1. Zip the Heavy World Data
          zip -r world.zip world world_nether world_the_end
          
          # 2. Upload World Zip to Release
          # Create tag if not exists
          gh release create backup --title "World Backup" --notes "Rolling backup of server world" world.zip --target $GITHUB_SHA || \
          gh release upload backup world.zip --clobber
          
          # 3. Clean up heavy files before git commit
          rm world.zip
          rm -rf world world_nether world_the_end server.jar libraries versions
          
          # 4. Commit smaller configs (whitelist, bans, logs) to repo
          cd ..
          git config --global user.name "GitHub Actions Server"
          git config --global user.email "actions@github.com"
          git add data/
          git commit -m "Save server configs and logs [skip ci]" || echo "No changes to commit"
          git push
